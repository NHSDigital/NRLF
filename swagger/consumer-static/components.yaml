components:
  securitySchemes:
    ${authoriser_name}:
      type: "apiKey"
      name: "Authorization"
      in: "header"
      x-amazon-apigateway-authtype: "custom"
      x-amazon-apigateway-authorizer:
        type: "request"
        authorizerUri: "${lambda_invoke_arn}"
        authorizerCredentials: "${authoriser_iam_role}"
        identitySource: "method.request.header.Authorization"
        authorizerResultTtlInSeconds: 0
  parameters:
    id:
      name: id
      in: path
      required: true
      description: logical identifier
      schema:
        $ref: "#/components/schemas/DocumentId"
    subject:
      name: subject.identifier
      in: query
      schema:
        $ref: "#/components/schemas/RequestQuerySubject"
      required: true
    custodian:
      name: custodian.identifier
      in: query
      schema:
        $ref: "#/components/schemas/RequestQueryCustodian"
    type:
      name: type.identifier
      in: query
      schema:
        $ref: "#/components/schemas/RequestQueryType"
    odsCode:
      name: NHSD-End-User-Organisation-ODS
      description: ODS Code for Organisation
      in: header
      schema:
        $ref: "#/components/schemas/RequestHeaderOdsCode"
      required: true
  requestBodies:
    DocumentReference:
      content:
        application/fhir+json:
          schema:
            $ref: "#/components/schemas/DocumentReference"
      required: true
  responses:
    Success:
      description: Success Response
      content:
        application/fhir+json:
          schema:
            $ref: "#/components/schemas/OperationOutcome"
    Error:
      description: Error Response
      content:
        application/fhir+json:
          schema:
            $ref: "#/components/schemas/OperationOutcome"
  schemas:
    DocumentId:
      type: string
      pattern: '[A-Za-z0-9\-\.]{1,64}' # https://build.fhir.org/datatypes.html#id
    RequestPathParams:
      type: object
      properties:
        id:
          $ref: "#/components/schemas/DocumentId"
      required:
        - id
    RequestHeader:
      type: object
      properties:
        odsCode:
          $ref: "#/components/schemas/RequestHeaderOdsCode"
      required:
        - odsCode
    RequestParams:
      type: object
      properties:
        subject.identifier:
          $ref: "#/components/schemas/RequestQuerySubject"
        custodian.identifier:
          $ref: "#/components/schemas/RequestQueryCustodian"
        type.identifier:
          $ref: "#/components/schemas/RequestQueryType"
      required:
        - subject.identifier
    RequestQuerySubject:
      type: string
      pattern: ^https\:\/\/fhir\.nhs\.uk\/Id\/nhs-number\|(\d+)$
    RequestQueryCustodian:
      type: string
      pattern: ^https\:\/\/fhir\.nhs\.uk\/Id\/ods-code\|(\w+)$
    RequestQueryType:
      type: string
      pattern: ^http\:\/\/snomed\.info\/sct\|(\d+)
    RequestHeaderOdsCode:
      type: string
